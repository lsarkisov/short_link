package com.lv.shortlink.controller;

import com.lv.shortlink.message.MessageTypes;
import com.lv.shortlink.message.ShortLinkMessage;
import com.lv.shortlink.model.ShortLinkModel;
import com.lv.shortlink.service.ShortLinkService;

import java.util.Scanner;

public class ShortLinkController {
    final Scanner scanner;
    final ShortLinkModel shortLinkModel;

    public ShortLinkController() {
        this.scanner = new Scanner(System.in);
        this.shortLinkModel = new ShortLinkModel();

        System.out.println(ShortLinkMessage.show(MessageTypes.WELCOME_MESSAGE));

        while (scanner.hasNextLine()) {
            final String[] params = scanner.nextLine().split(" ");
            switch (params.length) {
                case 1:
                    getShortLinkWithNoKeyword(params[0]);
                    break;
                case 2:
                    getShortLinkWithKeyword(params[0], params[1]);
                    break;
                default:
                    System.out.println(ShortLinkMessage.show(MessageTypes.ARGUMENTS_VALID));
            }
        }
    }

    /**
     * Generate short link with no keyword provided by user
     *
     * @param url provided by user that will be converted
     */
    public void getShortLinkWithNoKeyword(String url) {
        final String userLink = shortLinkModel.isShortLink(url);

        /**
         * if short link exists return user link
         */
        if (!userLink.isEmpty()) {
            System.out.println(userLink);

        }
        /**
         * if user quit the program
         */
        else if (url.equals("q")) {
            System.exit(1);

        }
        /**
         * if user link doesn't exist in store provide new short link
         */
        else {
            final String keyword = ShortLinkService.generateKeyword();

            if (validateIsShortLinkExists(ShortLinkService.host + keyword)) {
                getShortLinkWithNoKeyword(url);
            }

            if (validateUrl(url)) {
                final String shortLink = ShortLinkService.genShortLink(keyword);
                shortLinkModel.setShortLink(url, shortLink);
                System.out.println(shortLink);
            }
        }
    }

    /**
     * Generate short link with keyword provided by user
     *
     * @param url     provided by user that will be converted
     * @param keyword provided by user that will be used for short link path
     */
    public void getShortLinkWithKeyword(String url, String keyword) {
        if (validateAll(url, keyword)) {
            final String shortLink = ShortLinkService.genShortLink(keyword);
            shortLinkModel.setShortLink(url, shortLink);
            System.out.println(shortLink);
        }
    }

    /**
     * Validates user provided url if user doesn't provide keyword
     *
     * @param url provided by user
     * @return boolean
     */
    public boolean validateAll(String url) {
        return validateUrl(url);
    }

    /**
     * Validated user provided url and keyword
     *
     * @param url
     * @param keyword
     * @return boolean
     */
    public boolean validateAll(String url, String keyword) {
        return validateUrl(url)
                && validateKeyword(keyword)
                && !validateIsShortLinkExists(keyword);
    }

    /**
     * Validates user provided url
     *
     * @param url provided by user
     * @return boolean
     */
    public boolean validateUrl(String url) {
        if (!ShortLinkService.isUrlValid(url)) {
            System.out.println(ShortLinkMessage.show(MessageTypes.URL_VALID));
            return false;
        }
        return true;
    }

    /**
     * Validated the keyword that should be alphanumeric string and
     * has a length equal to 5
     *
     * @param keyword
     * @return boolean
     */
    public boolean validateKeyword(String keyword) {
        if (!ShortLinkService.isKeywordValid(keyword)) {
            System.out.println(ShortLinkMessage.show(MessageTypes.KEYWORD_VALID));
            return false;
        }
        return true;
    }

    /**
     * Checks if provided keyword exists in store
     *
     * @param keyword string provided by user on generated by default
     * @return boolean
     */
    public boolean validateIsShortLinkExists(String keyword) {
        if (shortLinkModel.isShortLinkExists(ShortLinkService.host + keyword)) {
            System.out.println(ShortLinkMessage.show(MessageTypes.SHORT_LINK_EXISTS, keyword));
            return true;
        }
        return false;
    }
}
